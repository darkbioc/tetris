<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ca"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Board.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;Tetris&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">Board.java</span></div><h1>Board.java</h1><pre class="source lang-java linenums">
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.*;

/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
/**
 *
 * @author victor
 */
public final class Board extends JPanel implements ActionListener {
<span class="fc" id="L21">    class MyKeyAdapter extends KeyAdapter </span>
    {
        @Override
        public void keyPressed(KeyEvent e) 
        {
<span class="pc bpc" id="L26" title="4 of 6 branches missed.">        switch (e.getKeyCode()) {</span>
        case KeyEvent.VK_LEFT:
<span class="pc bpc" id="L28" title="1 of 2 branches missed.">            if(canMove(currentShape,currentRow,currentCol-1))</span>
<span class="nc" id="L29">                currentCol--;</span>
            break;
        case KeyEvent.VK_RIGHT:
<span class="nc bnc" id="L32" title="All 2 branches missed.">            if(canMove(currentShape,currentRow,currentCol+1))</span>
<span class="nc" id="L33">                currentCol++;</span>
            break;
        case KeyEvent.VK_UP:
<span class="nc" id="L36">            Shape rotShape = currentShape.rotateRight();</span>
            /*if(currentRow!=20)
            {*/
<span class="nc bnc" id="L39" title="All 10 branches missed.">                if(currentCol==0 &amp;&amp; !(currentShape.getXMax()==1 &amp;&amp; currentShape.getXMin()==0 &amp;&amp; currentShape.getYMax()==1 &amp;&amp; currentShape.getYMin()==0))</span>
                {
<span class="nc bnc" id="L41" title="All 2 branches missed.">                    if(canMove(currentShape, currentRow, currentCol+1))</span>
                    {
<span class="nc bnc" id="L43" title="All 4 branches missed.">                        if(currentShape.getYMin()==-2 &amp;&amp; canMove(currentShape, currentRow, currentCol+2))</span>
                        {
<span class="nc bnc" id="L45" title="All 2 branches missed.">                            if(canMove(rotShape, currentRow, currentCol+2))</span>
                            {
<span class="nc" id="L47">                                currentCol+=2;</span>
<span class="nc" id="L48">                                currentShape=rotShape;</span>
                            }
                        }
<span class="nc bnc" id="L51" title="All 2 branches missed.">                        else if(currentShape.getYMax()==2)</span>
                        {
<span class="nc bnc" id="L53" title="All 2 branches missed.">                            if(canMove(rotShape, currentRow, currentCol+1))</span>
                            {
<span class="nc" id="L55">                                currentCol++;</span>
<span class="nc" id="L56">                                currentShape=rotShape;</span>
                            }
                        }
<span class="nc bnc" id="L59" title="All 2 branches missed.">                        else if (currentShape.getYMin()!=-2 )</span>
                        {
<span class="nc" id="L61">                            currentCol++;</span>
<span class="nc" id="L62">                            currentShape=rotShape;</span>
                        }                    
                    }
                }
<span class="nc bnc" id="L66" title="All 2 branches missed.">                else if(currentCol==NUM_COLS-1)</span>
                {
<span class="nc bnc" id="L68" title="All 2 branches missed.">                    if(canMove(currentShape, currentRow, currentCol-1))</span>
                    {
<span class="nc bnc" id="L70" title="All 4 branches missed.">                        if(currentShape.getYMax()==2 &amp;&amp; canMove(currentShape, currentRow, currentCol-2))</span>
                        {
<span class="nc bnc" id="L72" title="All 2 branches missed.">                            if(canMove(rotShape, currentRow, currentCol-2))</span>
                            {
<span class="nc" id="L74">                                currentCol-=2;</span>
<span class="nc" id="L75">                                currentShape=rotShape;</span>
                            }                      
                        }
<span class="nc bnc" id="L78" title="All 2 branches missed.">                        else if(currentShape.getYMin()==-2)</span>
                        {
<span class="nc bnc" id="L80" title="All 2 branches missed.">                            if(canMove(rotShape, currentRow, currentCol-1))</span>
                            {
<span class="nc" id="L82">                                currentCol--;</span>
<span class="nc" id="L83">                                currentShape=rotShape;</span>
                            }
                        }
<span class="nc bnc" id="L86" title="All 2 branches missed.">                        else if(currentShape.getYMax()!=2)</span>
                        {
<span class="nc" id="L88">                            currentCol--;</span>
<span class="nc" id="L89">                            currentShape=rotShape;</span>
                        }
                    }
                }
<span class="nc bnc" id="L93" title="All 4 branches missed.">                else if(currentCol==NUM_COLS-2 &amp;&amp; currentShape.getYMax()==2)</span>
                {
<span class="nc bnc" id="L95" title="All 2 branches missed.">                    if(canMove(rotShape, currentRow, currentCol-1))</span>
                    {
<span class="nc" id="L97">                        currentCol--;</span>
<span class="nc" id="L98">                        currentShape=rotShape;</span>
                    }
                }
<span class="nc bnc" id="L101" title="All 4 branches missed.">                else if(currentCol==1 &amp;&amp; currentShape.getYMin()==-2)</span>
                {
<span class="nc bnc" id="L103" title="All 2 branches missed.">                    if(canMove(rotShape, currentRow, currentCol+1))</span>
                    {
<span class="nc" id="L105">                        currentCol++;</span>
<span class="nc" id="L106">                        currentShape=rotShape;</span>
                    }
                }
<span class="nc bnc" id="L109" title="All 2 branches missed.">                else if(canMove(rotShape, currentRow, currentCol))</span>
                {
<span class="nc" id="L111">                    currentShape=rotShape;</span>
                }
<span class="nc bnc" id="L113" title="All 2 branches missed.">                else if(!canMove(rotShape, currentRow, currentCol))</span>
                {
<span class="nc bnc" id="L115" title="All 2 branches missed.">                    if(canMove(rotShape, currentRow, currentCol+1))</span>
                    {
<span class="nc" id="L117">                        currentCol++;</span>
<span class="nc" id="L118">                        currentShape=rotShape;</span>
                    }
<span class="nc bnc" id="L120" title="All 2 branches missed.">                    if(canMove(rotShape, currentRow, currentCol-1))</span>
                    {
<span class="nc" id="L122">                        currentCol--;</span>
<span class="nc" id="L123">                        currentShape=rotShape;</span>
                    }
<span class="nc bnc" id="L125" title="All 4 branches missed.">                    if(!canMove(rotShape, currentRow, currentCol+1) &amp;&amp; currentShape.getYMin()==-2)</span>
                    {
<span class="nc bnc" id="L127" title="All 2 branches missed.">                        if(canMove(rotShape, currentRow, currentCol+2))</span>
                        {
<span class="nc" id="L129">                            currentCol+=2;</span>
<span class="nc" id="L130">                            currentShape=rotShape;</span>
                        }
                    }
<span class="nc bnc" id="L133" title="All 4 branches missed.">                    if(!canMove(rotShape, currentRow, currentCol-1) &amp;&amp; currentShape.getYMax()==2)</span>
                    {
<span class="nc bnc" id="L135" title="All 2 branches missed.">                        if(canMove(rotShape, currentRow, currentCol-2))</span>
                        {
<span class="nc" id="L137">                            currentCol-=2;</span>
<span class="nc" id="L138">                            currentShape=rotShape;</span>
                        }
                    }
                //}
            /*if(canMove(rotShape,currentRow, currentCol))
            {
                currentShape=rotShape;
            }*/
            }
            
        break;
        case KeyEvent.VK_DOWN:
<span class="fc bfc" id="L150" title="All 2 branches covered.">            if(canMove(currentShape,currentRow+1, currentCol))</span>
<span class="fc" id="L151">                currentRow++;</span>
        break;
        case KeyEvent.VK_P:
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if(!timer.isRunning())</span>
            {
<span class="nc" id="L156">                scoreBoard.resume();</span>
<span class="nc" id="L157">                timer.start();</span>
            }
            else
            {
<span class="nc" id="L161">                timer.stop();</span>
<span class="nc" id="L162">                scoreBoard.pause();</span>
            }
<span class="nc" id="L164">        break;</span>
        default:
        break;
        }
<span class="fc" id="L168">        repaint();</span>
<span class="fc" id="L169">        }</span>
    }
    public ScoreBoard scoreBoard;
    
    public static final int NUM_ROWS = 22;
    public static final int NUM_COLS = 10;

    private final Tetrominoes[][] matrix;
    private int deltaTime;

    private Shape currentShape;

    private int currentRow;
    private int currentCol;

    private final Timer timer;
    
<span class="fc" id="L186">    private final boolean paused=false;</span>
    MyKeyAdapter keyAdepter;
    
    public static final int INIT_ROW = -1;

    public Board() {
<span class="fc" id="L192">        super();</span>
<span class="fc" id="L193">        matrix = new Tetrominoes[NUM_ROWS][NUM_COLS];</span>
<span class="fc" id="L194">        initValues();</span>
<span class="fc" id="L195">        timer = new Timer(deltaTime, this);</span>
<span class="fc" id="L196">        keyAdepter= new MyKeyAdapter();</span>
        
<span class="fc" id="L198">    }</span>

    public void initValues() {
<span class="fc" id="L201">        setFocusable(true);</span>
<span class="fc" id="L202">        cleanBoard();</span>
<span class="fc" id="L203">        deltaTime = 500;</span>
<span class="fc" id="L204">        currentShape = null;</span>
<span class="fc" id="L205">        currentRow = INIT_ROW;</span>
<span class="fc" id="L206">        currentCol = NUM_COLS / 2;</span>
<span class="fc" id="L207">    }</span>

    public void initGame() {
<span class="fc" id="L210">        removeKeyListener(keyAdepter);</span>
<span class="fc" id="L211">        initValues();</span>
<span class="fc" id="L212">        timer.setDelay(deltaTime);</span>
<span class="fc" id="L213">        currentShape = new Shape();</span>
<span class="fc" id="L214">        timer.start();</span>
<span class="fc" id="L215">        addKeyListener(keyAdepter);</span>
        
<span class="fc" id="L217">    }</span>
    
    public void setScoreBoard(ScoreBoard scoreboard)
    {
<span class="fc" id="L221">        this.scoreBoard=scoreboard;</span>
<span class="fc" id="L222">    }</span>

    public void cleanBoard() {
<span class="fc bfc" id="L225" title="All 2 branches covered.">        for (int row = 0; row &lt; NUM_ROWS; row++) {</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">            for (int col = 0; col &lt; NUM_COLS; col++) {</span>
<span class="fc" id="L227">                matrix[row][col] = Tetrominoes.NoShape;</span>
            }
        }
<span class="fc" id="L230">    }</span>

    // Game Main Loop
    @Override
    public void actionPerformed(ActionEvent ae) 
    {
<span class="fc bfc" id="L236" title="All 2 branches covered.">        if(canMove(currentShape,currentRow+1, currentCol))</span>
        {
<span class="fc" id="L238">            System.out.println(&quot;Current col: &quot;+currentCol+&quot; YMax: &quot;+currentShape.getYMax()+&quot; YMin: &quot;+currentShape.getYMin()+&quot; Current row: &quot;+currentRow+&quot; DTime: &quot;+deltaTime+&quot; Score: &quot;+scoreBoard.getScore());</span>
<span class="fc" id="L239">            currentRow++;</span>
<span class="fc" id="L240">            repaint();</span>
        }
        else
        {
<span class="fc bfc" id="L244" title="All 2 branches covered.">            if(currentShape.getYMin()+currentRow&lt;0)</span>
            {
                try 
                {
<span class="fc" id="L248">                    gameOver();</span>
<span class="fc" id="L249">                    timer.stop();</span>
                } 
<span class="nc" id="L251">                catch (InterruptedException ex) </span>
                {
<span class="pc" id="L253">                }</span>
            }
            else
            {
<span class="fc" id="L257">                moveCurrentShapeToMatrix();</span>
<span class="fc" id="L258">                checkRows();</span>
<span class="fc" id="L259">                currentShape = new Shape();</span>
<span class="fc" id="L260">                currentRow = INIT_ROW;</span>
<span class="fc" id="L261">                currentCol = NUM_COLS/2;</span>
            }
            
        }
<span class="fc" id="L265">    }</span>
    private void moveCurrentShapeToMatrix()
    {
<span class="fc" id="L268">        int[][] squaresArray = currentShape.getCoordinates();</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">        for(int point = 0; point&lt;=3; point++)</span>
        {
<span class="fc" id="L271">            matrix[currentRow+squaresArray[point][1]][currentCol+squaresArray[point][0]]=currentShape.getShape();</span>
        }
<span class="fc" id="L273">    }</span>

    @Override
    protected void paintComponent(Graphics g) {
<span class="fc" id="L277">        super.paintComponent(g);</span>
<span class="fc" id="L278">        drawBoard(g);</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">        if (currentShape!=null)</span>
<span class="fc" id="L280">        drawCurrentShape(g);</span>
<span class="fc" id="L281">    }</span>
    public void drawBoard(Graphics g)
    {
<span class="fc bfc" id="L284" title="All 2 branches covered.">        for (int row = 0; row &lt; NUM_ROWS; row++) </span>
        {
<span class="fc bfc" id="L286" title="All 2 branches covered.">            for (int col = 0; col &lt; NUM_COLS; col++) </span>
            {
<span class="fc" id="L288">                drawSquare(g, row, col, matrix[row][col]);</span>
            }
        }
<span class="fc" id="L291">    }</span>
    private void drawSquare(Graphics g, int row, int col, Tetrominoes shape) {
<span class="fc" id="L293">        Color colors[] = {new Color(0, 0, 0),</span>
            new Color(204, 102, 102),
            new Color(102, 204, 102), new Color(102, 102, 204),
            new Color(204, 204, 102), new Color(204, 102, 204),
            new Color(102, 204, 204), new Color(218, 170, 0)
        };
<span class="fc" id="L299">        int x = col * squareWidth();</span>
<span class="fc" id="L300">        int y = row * squareHeight();</span>
<span class="fc" id="L301">        Color color = colors[shape.ordinal()];</span>
<span class="fc" id="L302">        g.setColor(color);</span>
<span class="fc" id="L303">        g.fillRect(x + 1, y + 1, squareWidth() - 2,</span>
<span class="fc" id="L304">                squareHeight() - 2);</span>
<span class="fc" id="L305">        g.setColor(color.brighter());</span>
<span class="fc" id="L306">        g.drawLine(x, y + squareHeight() - 1, x, y);</span>
<span class="fc" id="L307">        g.drawLine(x, y, x + squareWidth() - 1, y);</span>
<span class="fc" id="L308">        g.setColor(color.darker());</span>
<span class="fc" id="L309">        g.drawLine(x + 1, y + squareHeight() - 1,</span>
<span class="fc" id="L310">                x + squareWidth() - 1, y + squareHeight() - 1);</span>
<span class="fc" id="L311">        g.drawLine(x + squareWidth() - 1,</span>
<span class="fc" id="L312">                y + squareHeight() - 1,</span>
<span class="fc" id="L313">                x + squareWidth() - 1, y + 1);</span>
<span class="fc" id="L314">    }</span>
    
    private int squareWidth() {
<span class="fc" id="L317">        return getWidth() / NUM_COLS;</span>
    }
    
    private int squareHeight() {
<span class="fc" id="L321">        return getHeight() / NUM_ROWS;</span>
    }
    private void drawCurrentShape(Graphics g) 
    {
<span class="fc" id="L325">    int[][] squaresArray = currentShape.getCoordinates();</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">    for(int point = 0; point&lt;=3; point++)</span>
        {
<span class="fc" id="L328">        drawSquare(g, currentRow + squaresArray[point][1], currentCol + squaresArray[point][0], currentShape.getShape());</span>
        }
<span class="fc" id="L330">    }</span>
    
    private boolean canMove(Shape shape, int newRow, int newCol)
    {
<span class="pc bpc" id="L334" title="2 of 8 branches missed.">        return !(newCol + shape.getXMin()&lt;0 || (newCol+shape.getXMax()&gt;= NUM_COLS || newRow + shape.getYMax()&gt;=NUM_ROWS || hitWithMatrix(shape,newRow, newCol)));</span>
    }
    private boolean hitWithMatrix(Shape shape, int row, int col)
    {
<span class="fc" id="L338">        int[][] squaresArray = shape.getCoordinates();</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">        for(int point = 0; point&lt;=3; point++)</span>
        {
<span class="fc" id="L341">            int mRow = row+squaresArray[point][1];</span>
<span class="fc" id="L342">            int mCol = col+squaresArray[point][0];</span>
<span class="fc bfc" id="L343" title="All 2 branches covered.">            if(mRow &gt;= 0)</span>
            {
<span class="fc bfc" id="L345" title="All 2 branches covered.">                if(matrix[mRow][mCol] != Tetrominoes.NoShape)</span>
                {
<span class="fc" id="L347">                    return true;</span>
                }
            }
        }
<span class="fc" id="L351">        return false;</span>
    }
    public void checkRows()
    {
<span class="fc" id="L355">        int dRows = 0;</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">        for (int i = 0; i &lt; NUM_ROWS; i++) </span>
        {
<span class="fc" id="L358">            int  counter=0;</span>
<span class="fc bfc" id="L359" title="All 2 branches covered.">            for (int j = 0; j &lt; NUM_COLS; j++) </span>
            {
<span class="fc bfc" id="L361" title="All 2 branches covered.">                if(matrix[i][j]!=Tetrominoes.NoShape)</span>
                {
<span class="fc" id="L363">                    counter++;</span>
                }
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">                if(counter==10)</span>
                {
<span class="nc" id="L367">                    dRows++;</span>
<span class="nc" id="L368">                    scoreBoard.increment(100);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                    if(dRows==4)</span>
<span class="nc" id="L370">                        scoreBoard.increment(50);</span>
<span class="nc bnc" id="L371" title="All 4 branches missed.">                    if(scoreBoard.getScore()%(500*scoreBoard.getLevel()+1)==0 &amp;&amp; deltaTime!=50)</span>
                    {
<span class="nc" id="L373">                        scoreBoard.newLevel();</span>
<span class="nc" id="L374">                        deltaTime-=100;</span>
<span class="nc" id="L375">                        timer.setDelay(deltaTime);</span>
                    }
<span class="nc bnc" id="L377" title="All 2 branches missed.">                    for (int k = i; k &gt; 0; k--) </span>
                    {
<span class="nc" id="L379">                        System.arraycopy(matrix[k-1], 0, matrix[k], 0, NUM_COLS);</span>
                    }
<span class="nc bnc" id="L381" title="All 2 branches missed.">                    for (int k = 0; k &lt; NUM_COLS; k++) </span>
                    {
<span class="nc" id="L383">                        matrix[0][k]=Tetrominoes.NoShape;</span>
                    }
                }
            }
        }
<span class="fc" id="L388">    }</span>
    public void gameOver() throws InterruptedException
    {
<span class="fc" id="L391">        scoreBoard.gameOver();</span>
<span class="fc bfc" id="L392" title="All 2 branches covered.">        for (int row = 0; row &lt; NUM_ROWS; row++) </span>
        {
<span class="fc bfc" id="L394" title="All 2 branches covered.">            for (int col = 0; col &lt; NUM_COLS; col++) </span>
            {
<span class="fc" id="L396">                matrix[row][col] = Tetrominoes.ZShape;</span>
            }
        }
<span class="fc" id="L399">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>